<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Proveedores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .nav-custom {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        }
        .btn-nav {
            transition: all 0.3s ease;
            border: none;
            margin: 2px;
        }
        .btn-nav:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-products { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        .btn-suppliers { background: linear-gradient(135deg, #e67e22, #f39c12); color: white; }
        .btn-clients { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .btn-sales { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }
        .btn-action { margin: 1px; }
        .card-header-custom {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
        }
    </style>
</head>
<body>
<!-- Barra de navegación superior -->
<nav class="navbar navbar-expand-lg navbar-dark nav-custom">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">
            <i class="bi bi-shop"></i> Gestión de Inventario
        </span>

        <!-- Botones de navegación -->
        <div class="navbar-nav ms-auto">
            <div class="d-flex flex-wrap">
                <a href="/productos" class="btn btn-nav btn-products me-2">
                    <i class="bi bi-box-seam"></i> Productos
                </a>
                <a href="/proveedores" class="btn btn-nav btn-suppliers me-2">
                    <i class="bi bi-truck"></i> Proveedores
                </a>
                <a href="/clientes" class="btn btn-nav btn-clients me-2">
                    <i class="bi bi-people-fill"></i> Clientes
                </a>
                <a href="/ventas" class="btn btn-nav btn-sales">
                    <i class="bi bi-cart-check"></i> Ventas
                </a>
            </div>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header card-header-custom">
                    <h4 class="mb-0"><i class="bi bi-truck"></i> Gestión de Proveedores</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón para abrir modal de crear proveedor -->
    <div class="row mb-3">
        <div class="col-12">
            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalProveedor" onclick="limpiarFormulario()">
                <i class="bi bi-building-add"></i> Nuevo Proveedor
            </button>
        </div>
    </div>

    <!-- Buscadores -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-search"></i> Buscar por Nombre</h5>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchNombre" placeholder="Ingrese nombre...">
                        <button class="btn btn-warning" type="button" onclick="buscarPorNombre()">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                        <button class="btn btn-secondary" type="button" onclick="cargarProveedores()">
                            <i class="bi bi-arrow-clockwise"></i> Todos
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-building"></i> Buscar por RUC</h5>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchRuc" placeholder="Ingrese RUC...">
                        <button class="btn btn-warning" type="button" onclick="buscarPorRuc()">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de proveedores -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header card-header-custom">
                    <h5 class="card-title mb-0"><i class="bi bi-list-ul"></i> Lista de Proveedores</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead class="table-dark">
                            <tr>
                                <th><i class="bi bi-hash"></i> ID</th>
                                <th><i class="bi bi-building"></i> RUC</th>
                                <th><i class="bi bi-building"></i> Nombre</th>
                                <th><i class="bi bi-person"></i> Contacto</th>
                                <th><i class="bi bi-envelope"></i> Email</th>
                                <th><i class="bi bi-telephone"></i> Teléfono</th>
                                <th><i class="bi bi-gear"></i> Acciones</th>
                            </tr>
                            </thead>
                            <tbody id="tablaProveedores">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner-border text-warning" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar proveedor -->
<div class="modal fade" id="modalProveedor" tabindex="-1" aria-labelledby="modalProveedorLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="modalProveedorLabel"><i class="bi bi-building-add"></i> Nuevo Proveedor</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formProveedor">
                    <input type="hidden" id="proveedorId">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ruc" class="form-label"><i class="bi bi-building"></i> RUC *</label>
                            <input type="text" class="form-control" id="ruc" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="nombre" class="form-label"><i class="bi bi-building"></i> Nombre Empresa *</label>
                            <input type="text" class="form-control" id="nombre" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contacto" class="form-label"><i class="bi bi-person"></i> Persona de Contacto</label>
                            <input type="text" class="form-control" id="contacto">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label"><i class="bi bi-envelope"></i> Email</label>
                            <input type="email" class="form-control" id="email">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="telefono" class="form-label"><i class="bi bi-telephone"></i> Teléfono</label>
                            <input type="tel" class="form-control" id="telefono">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="direccion" class="form-label"><i class="bi bi-geo-alt"></i> Dirección</label>
                            <input type="text" class="form-control" id="direccion">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="guardarProveedor()">
                    <i class="bi bi-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles del proveedor -->
<div class="modal fade" id="modalDetalles" tabindex="-1" aria-labelledby="modalDetallesLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalDetallesLabel"><i class="bi bi-eye"></i> Detalles del Proveedor</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detallesProveedor">
                <!-- Se llenará dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Cargar proveedores al iniciar
    document.addEventListener('DOMContentLoaded', function() {
        cargarProveedores();
    });

    // Función para cargar todos los proveedores
    function cargarProveedores() {
        fetch('/proveedores/api')
            .then(response => {
                console.log('Status carga proveedores:', response.status);
                if (!response.ok) throw new Error('Error al cargar proveedores: ' + response.status);
                return response.json();
            })
            .then(proveedores => {
                console.log('Proveedores cargados:', proveedores);
                mostrarProveedores(proveedores);
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al cargar proveedores: ' + error.message, 'danger');
            });
    }

    // Mostrar proveedores en la tabla
    function mostrarProveedores(proveedores) {
        const tbody = document.getElementById('tablaProveedores');

        if (proveedores.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="bi bi-truck display-4"></i><br>
                        No se encontraron proveedores
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = proveedores.map(proveedor => `
            <tr>
                <td><span class="badge bg-secondary">${proveedor.id || 'N/A'}</span></td>
                <td><strong>${proveedor.ruc || ''}</strong></td>
                <td>${proveedor.nombre || ''}</td>
                <td>${proveedor.contacto || '<span class="text-muted">N/A</span>'}</td>
                <td>${proveedor.email || '<span class="text-muted">N/A</span>'}</td>
                <td>${proveedor.telefono || '<span class="text-muted">N/A</span>'}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-info btn-action" onclick="verProveedor(${proveedor.id})" title="Ver detalles">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning btn-action" onclick="editarProveedor(${proveedor.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-action" onclick="eliminarProveedor(${proveedor.id})" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Guardar proveedor (crear o actualizar)
    function guardarProveedor() {
        const id = document.getElementById('proveedorId').value;
        const ruc = document.getElementById('ruc').value;
        const nombre = document.getElementById('nombre').value;
        const contacto = document.getElementById('contacto').value;
        const email = document.getElementById('email').value;
        const telefono = document.getElementById('telefono').value;
        const direccion = document.getElementById('direccion').value;

        // Validaciones
        if (!ruc || !nombre) {
            mostrarAlerta('RUC y Nombre son obligatorios', 'warning');
            return;
        }

        const proveedor = {
            ruc: ruc,
            nombre: nombre,
            contacto: contacto,
            email: email,
            telefono: telefono,
            direccion: direccion
        };

        const url = id ? `/proveedores/api/${id}` : '/proveedores/api';
        const method = id ? 'PUT' : 'POST';

        console.log('Enviando proveedor:', proveedor);
        console.log('URL:', url, 'Method:', method);

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(proveedor)
        })
            .then(response => {
                console.log('Response status:', response.status);

                if (!response.ok) {
                    return response.text().then(errorText => {
                        console.error('Error response:', errorText);
                        throw new Error(`Error ${response.status}: ${errorText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Proveedor guardado exitosamente:', data);
                mostrarAlerta('Proveedor guardado exitosamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalProveedor')).hide();
                cargarProveedores();
                document.getElementById('formProveedor').reset();
            })
            .catch(error => {
                console.error('Error completo:', error);
                mostrarAlerta(`Error al guardar: ${error.message}`, 'danger');
            });
    }

    // Ver detalles del proveedor
    function verProveedor(id) {
        fetch(`/proveedores/api/${id}`)
            .then(response => {
                if (!response.ok) throw new Error('Proveedor no encontrado');
                return response.json();
            })
            .then(proveedor => {
                document.getElementById('detallesProveedor').innerHTML = `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-hash"></i> ID:</strong> ${proveedor.id}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-building"></i> RUC:</strong> ${proveedor.ruc}
                        </div>
                        <div class="col-12 mb-3">
                            <strong><i class="bi bi-building"></i> Nombre Empresa:</strong> ${proveedor.nombre || ''}
                        </div>
                        <div class="col-12 mb-3">
                            <strong><i class="bi bi-person"></i> Contacto:</strong> ${proveedor.contacto || 'N/A'}
                        </div>
                        <div class="col-12 mb-3">
                            <strong><i class="bi bi-envelope"></i> Email:</strong> ${proveedor.email || 'N/A'}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-telephone"></i> Teléfono:</strong> ${proveedor.telefono || 'N/A'}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-calendar"></i> Fecha Registro:</strong> ${proveedor.fechaRegistro ? new Date(proveedor.fechaRegistro).toLocaleString() : 'N/A'}
                        </div>
                        <div class="col-12 mb-3">
                            <strong><i class="bi bi-geo-alt"></i> Dirección:</strong> ${proveedor.direccion || 'N/A'}
                        </div>
                    </div>
                `;
                new bootstrap.Modal(document.getElementById('modalDetalles')).show();
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al cargar el proveedor', 'danger');
            });
    }

    // Editar proveedor
    function editarProveedor(id) {
        fetch(`/proveedores/api/${id}`)
            .then(response => {
                if (!response.ok) throw new Error('Proveedor no encontrado');
                return response.json();
            })
            .then(proveedor => {
                document.getElementById('proveedorId').value = proveedor.id;
                document.getElementById('ruc').value = proveedor.ruc;
                document.getElementById('nombre').value = proveedor.nombre;
                document.getElementById('contacto').value = proveedor.contacto || '';
                document.getElementById('email').value = proveedor.email || '';
                document.getElementById('telefono').value = proveedor.telefono || '';
                document.getElementById('direccion').value = proveedor.direccion || '';

                document.getElementById('modalProveedorLabel').innerHTML = '<i class="bi bi-pencil"></i> Editar Proveedor';
                document.getElementById('ruc').disabled = true;

                new bootstrap.Modal(document.getElementById('modalProveedor')).show();
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al cargar el proveedor', 'danger');
            });
    }

    // Eliminar proveedor
    function eliminarProveedor(id) {
        if (confirm('¿Está seguro de eliminar este proveedor?')) {
            fetch(`/proveedores/api/${id}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (response.ok) {
                        mostrarAlerta('Proveedor eliminado exitosamente', 'success');
                        cargarProveedores();
                    } else {
                        throw new Error('Error al eliminar');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarAlerta('Error al eliminar el proveedor', 'danger');
                });
        }
    }

    // Buscar por nombre
    function buscarPorNombre() {
        const nombre = document.getElementById('searchNombre').value;

        if (!nombre.trim()) {
            mostrarAlerta('Ingrese un nombre para buscar', 'warning');
            return;
        }

        fetch(`/proveedores/api/buscar?nombre=${encodeURIComponent(nombre)}`)
            .then(response => {
                if (!response.ok) throw new Error('Error en búsqueda');
                return response.json();
            })
            .then(proveedores => {
                mostrarProveedores(proveedores);
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al buscar proveedores', 'danger');
            });
    }

    // Buscar por RUC
    function buscarPorRuc() {
        const ruc = document.getElementById('searchRuc').value;

        if (!ruc.trim()) {
            mostrarAlerta('Ingrese un RUC para buscar', 'warning');
            return;
        }

        fetch(`/proveedores/api/ruc/${encodeURIComponent(ruc)}`)
            .then(response => {
                if (!response.ok) throw new Error('Proveedor no encontrado');
                return response.json();
            })
            .then(proveedor => {
                mostrarProveedores([proveedor]);
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Proveedor no encontrado', 'warning');
            });
    }

    // Limpiar formulario
    function limpiarFormulario() {
        document.getElementById('formProveedor').reset();
        document.getElementById('proveedorId').value = '';
        document.getElementById('modalProveedorLabel').innerHTML = '<i class="bi bi-building-add"></i> Nuevo Proveedor';
        document.getElementById('ruc').disabled = false;
    }

    // Mostrar alertas
    function mostrarAlerta(mensaje, tipo) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            <i class="bi bi-${tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'} me-2"></i>
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }

    // Permitir buscar con Enter
    document.getElementById('searchNombre')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            buscarPorNombre();
        }
    });

    document.getElementById('searchRuc')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            buscarPorRuc();
        }
    });
</script>
</body>
</html>