<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Ventas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="/gestion.css" rel="stylesheet">

</head>
<body>
<!-- Barra de navegación superior -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">
            <i class="bi bi-shop"></i> Gestión de Inventario
        </span>

        <!-- Botones de navegación -->
        <div class="navbar-nav ms-auto">
            <div class="d-flex flex-wrap">
                <a href="/productos" class="btn btn-success me-2">
                    <i class="bi bi-box-seam"></i> Productos
                </a>
                <a href="/proveedores" class="btn btn-warning me-2">
                    <i class="bi bi-truck"></i> Proveedores
                </a>
                <a href="/clientes" class="btn btn-info me-2">
                    <i class="bi bi-people-fill"></i> Clientes
                </a>
                <a href="/ventas" class="btn btn-purple" style="background-color: #9b59b6; color: white;">
                    <i class="bi bi-cart-check"></i> Ventas
                </a>
            </div>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0"><i class="bi bi-cart-check"></i> Gestión de Ventas</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón para abrir modal de crear venta -->
    <div class="row mb-3">
        <div class="col-12">
            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalVenta" onclick="limpiarFormulario()">
                <i class="bi bi-cart-plus"></i> Nueva Venta
            </button>
        </div>
    </div>

    <!-- Buscadores y filtros -->
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-search"></i> Buscar por Factura</h5>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchFactura" placeholder="Número de factura...">
                        <button class="btn btn-warning" type="button" onclick="buscarPorFactura()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-person"></i> Buscar por Cliente</h5>
                    <div class="input-group">
                        <input type="number" class="form-control" id="searchCliente" placeholder="ID Cliente...">
                        <button class="btn btn-warning" type="button" onclick="buscarPorCliente()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-filter"></i> Filtrar por Estado</h5>
                    <select class="form-select" id="filterEstado" onchange="filtrarPorEstado()">
                        <option value="">Todos los estados</option>
                        <option value="PENDIENTE">Pendiente</option>
                        <option value="COMPLETADA">Completada</option>
                        <option value="CANCELADA">Cancelada</option>
                        <option value="EN_PROCESO">En Proceso</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de ventas -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-list-ul"></i> Lista de Ventas</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead class="table-dark">
                            <tr>
                                <th><i class="bi bi-hash"></i> ID</th>
                                <th><i class="bi bi-receipt"></i> Factura</th>
                                <th><i class="bi bi-person"></i> Cliente</th>
                                <th><i class="bi bi-calendar"></i> Fecha</th>
                                <th><i class="bi bi-currency-dollar"></i> Total</th>
                                <th><i class="bi bi-tags"></i> Estado</th>
                                <th><i class="bi bi-gear"></i> Acciones</th>
                            </tr>
                            </thead>
                            <tbody id="tablaVentas">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner-border text-warning" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar venta -->
<div class="modal fade" id="modalVenta" tabindex="-1" aria-labelledby="modalVentaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="modalVentaLabel"><i class="bi bi-cart-plus"></i> Nueva Venta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formVenta">
                    <input type="hidden" id="ventaId">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="numeroFactura" class="form-label"><i class="bi bi-receipt"></i> Número de Factura *</label>
                            <input type="text" class="form-control" id="numeroFactura" required>
                        </div>
                        <div class="col-md-6">
                            <label for="clienteId" class="form-label"><i class="bi bi-person"></i> Cliente ID *</label>
                            <input type="number" class="form-control" id="clienteId" required>
                        </div>
                    </div>

                    <!-- Detalles de la venta -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h5><i class="bi bi-list-check"></i> Detalles de la Venta</h5>
                            <div class="table-responsive">
                                <table class="table table-sm" id="tablaDetalles">
                                    <thead class="table-secondary">
                                    <tr>
                                        <th>Producto ID</th>
                                        <th>Cantidad</th>
                                        <th>Precio Unitario</th>
                                        <th>Subtotal</th>
                                        <th>Acciones</th>
                                    </tr>
                                    </thead>
                                    <tbody id="cuerpoDetalles">
                                    <!-- Se llenará dinámicamente -->
                                    </tbody>
                                    <tfoot>
                                    <tr>
                                        <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                        <td><strong id="totalVenta">0.00</strong></td>
                                        <td></td>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="agregarDetalle()">
                                <i class="bi bi-plus-circle"></i> Agregar Producto
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="guardarVenta()">
                    <i class="bi bi-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles de la venta -->
<div class="modal fade" id="modalDetallesVenta" tabindex="-1" aria-labelledby="modalDetallesVentaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalDetallesVentaLabel"><i class="bi bi-eye"></i> Detalles de la Venta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detallesVenta">
                <!-- Se llenará dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para cambiar estado -->
<div class="modal fade" id="modalEstado" tabindex="-1" aria-labelledby="modalEstadoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalEstadoLabel"><i class="bi bi-tags"></i> Cambiar Estado</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="ventaIdEstado">
                <div class="mb-3">
                    <label for="nuevoEstado" class="form-label">Nuevo Estado:</label>
                    <select class="form-select" id="nuevoEstado">
                        <option value="PENDIENTE">Pendiente</option>
                        <option value="EN_PROCESO">En Proceso</option>
                        <option value="COMPLETADA">Completada</option>
                        <option value="CANCELADA">Cancelada</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarCambioEstado()">Cambiar Estado</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let contadorDetalles = 0;

    // Cargar ventas al iniciar
    document.addEventListener('DOMContentLoaded', function() {
        cargarVentas();
    });

    // Función para cargar todas las ventas
    function cargarVentas() {
        fetch('/ventas/api')
            .then(response => {
                console.log('Status carga ventas:', response.status);
                if (!response.ok) throw new Error('Error al cargar ventas: ' + response.status);
                return response.json();
            })
            .then(ventas => {
                console.log('Ventas cargadas:', ventas);
                mostrarVentas(ventas);
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al cargar ventas: ' + error.message, 'danger');
            });
    }

    // Mostrar ventas en la tabla
    function mostrarVentas(ventas) {
        const tbody = document.getElementById('tablaVentas');

        if (ventas.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="bi bi-cart display-4"></i><br>
                        No se encontraron ventas
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = ventas.map(venta => `
            <tr>
                <td><span class="badge bg-secondary">${venta.id || 'N/A'}</span></td>
                <td><strong>${venta.numeroFactura || ''}</strong></td>
                <td>${venta.clienteId || 'N/A'}</td>
                <td>${venta.fechaVenta ? new Date(venta.fechaVenta).toLocaleString() : 'N/A'}</td>
                <td><strong>$${venta.total ? venta.total.toFixed(2) : '0.00'}</strong></td>
                <td>
                    <span class="badge ${getClaseEstado(venta.estado)}">${venta.estado || 'N/A'}</span>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-info btn-action" onclick="verVenta(${venta.id})" title="Ver detalles">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning btn-action" onclick="editarVenta(${venta.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-primary btn-action" onclick="cambiarEstadoVenta(${venta.id})" title="Cambiar estado">
                            <i class="bi bi-tags"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-action" onclick="eliminarVenta(${venta.id})" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Obtener clase CSS para el estado
    function getClaseEstado(estado) {
        switch(estado) {
            case 'PENDIENTE': return 'bg-warning text-dark';
            case 'COMPLETADA': return 'bg-success';
            case 'CANCELADA': return 'bg-danger';
            case 'EN_PROCESO': return 'bg-info';
            default: return 'bg-secondary';
        }
    }

    // Agregar detalle a la venta
    function agregarDetalle() {
        contadorDetalles++;
        const tbody = document.getElementById('cuerpoDetalles');
        const nuevaFila = `
            <tr id="detalle-${contadorDetalles}">
                <td>
                    <input type="number" class="form-control form-control-sm producto-id"
                           onchange="calcularSubtotal(${contadorDetalles})" required>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm cantidad"
                           value="1" min="1" onchange="calcularSubtotal(${contadorDetalles})" required>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm precio"
                           step="0.01" min="0" onchange="calcularSubtotal(${contadorDetalles})" required>
                </td>
                <td>
                    <span class="subtotal">0.00</span>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger"
                            onclick="eliminarDetalle(${contadorDetalles})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += nuevaFila;
        calcularTotal();
    }

    // Eliminar detalle
    function eliminarDetalle(id) {
        const fila = document.getElementById(`detalle-${id}`);
        if (fila) {
            fila.remove();
            calcularTotal();
        }
    }

    // Calcular subtotal de un detalle
    function calcularSubtotal(id) {
        const fila = document.getElementById(`detalle-${id}`);
        const cantidad = parseFloat(fila.querySelector('.cantidad').value) || 0;
        const precio = parseFloat(fila.querySelector('.precio').value) || 0;
        const subtotal = cantidad * precio;

        fila.querySelector('.subtotal').textContent = subtotal.toFixed(2);
        calcularTotal();
    }

    // Calcular total de la venta
    function calcularTotal() {
        const subtotales = document.querySelectorAll('.subtotal');
        let total = 0;

        subtotales.forEach(subtotal => {
            total += parseFloat(subtotal.textContent) || 0;
        });

        document.getElementById('totalVenta').textContent = total.toFixed(2);
    }

    // Guardar venta (crear o actualizar)
    function guardarVenta() {
        const id = document.getElementById('ventaId').value;
        const numeroFactura = document.getElementById('numeroFactura').value;
        const clienteId = document.getElementById('clienteId').value;

        // Validaciones básicas
        if (!numeroFactura || !clienteId) {
            mostrarAlerta('Número de factura y Cliente son obligatorios', 'warning');
            return;
        }

        // Obtener detalles
        const detalles = [];
        const filasDetalles = document.querySelectorAll('#cuerpoDetalles tr');

        if (filasDetalles.length === 0) {
            mostrarAlerta('Debe agregar al menos un producto a la venta', 'warning');
            return;
        }

        filasDetalles.forEach(fila => {
            const productoid = fila.querySelector('.producto-id').value;
            const cantidad = fila.querySelector('.cantidad').value;
            const precioUnitario = fila.querySelector('.precio').value;
            const subtotal = fila.querySelector('.subtotal').textContent;

            if (productoid && cantidad && precioUnitario) {
                detalles.push({
                    productoid: parseInt(productoid),
                    cantidad: parseInt(cantidad),
                    precioUnitario: parseFloat(precioUnitario),
                    subtotal: parseFloat(subtotal)
                });
            }
        });

        const venta = {
            numeroFactura: numeroFactura,
            clienteId: parseInt(clienteId),
            total: parseFloat(document.getElementById('totalVenta').textContent),
            detalles: detalles
        };

        const url = id ? `/ventas/api/${id}` : '/ventas/api';
        const method = id ? 'PUT' : 'POST';

        console.log('Enviando venta:', venta);

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(venta)
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(errorText => {
                        throw new Error(`Error ${response.status}: ${errorText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                mostrarAlerta('Venta guardada exitosamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalVenta')).hide();
                cargarVentas();
                limpiarFormulario();
            })
            .catch(error => {
                console.error('Error completo:', error);
                mostrarAlerta(`Error al guardar: ${error.message}`, 'danger');
            });
    }

    // Ver detalles de la venta
    function verVenta(id) {
        fetch(`/ventas/api/${id}`)
            .then(response => {
                if (!response.ok) throw new Error('Venta no encontrada');
                return response.json();
            })
            .then(venta => {
                let detallesHtml = '';
                if (venta.detalles && venta.detalles.length > 0) {
                    detallesHtml = venta.detalles.map(detalle => `
                        <tr>
                            <td>${detalle.productoid || 'N/A'}</td>
                            <td>${detalle.cantidad || 0}</td>
                            <td>$${detalle.precioUnitario ? detalle.precioUnitario.toFixed(2) : '0.00'}</td>
                            <td>$${detalle.subtotal ? detalle.subtotal.toFixed(2) : '0.00'}</td>
                        </tr>
                    `).join('');
                }

                document.getElementById('detallesVenta').innerHTML = `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-hash"></i> ID:</strong> ${venta.id}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-receipt"></i> Factura:</strong> ${venta.numeroFactura}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-person"></i> Cliente ID:</strong> ${venta.clienteId}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-calendar"></i> Fecha:</strong> ${venta.fechaVenta ? new Date(venta.fechaVenta).toLocaleString() : 'N/A'}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-currency-dollar"></i> Total:</strong> $${venta.total ? venta.total.toFixed(2) : '0.00'}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-tags"></i> Estado:</strong>
                            <span class="badge ${getClaseEstado(venta.estado)}">${venta.estado || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6><i class="bi bi-list-check"></i> Detalles de Productos:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Producto ID</th>
                                            <th>Cantidad</th>
                                            <th>Precio Unitario</th>
                                            <th>Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${detallesHtml || '<tr><td colspan="4" class="text-center">No hay detalles</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                new bootstrap.Modal(document.getElementById('modalDetallesVenta')).show();
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al cargar la venta', 'danger');
            });
    }

    // Editar venta
    function editarVenta(id) {
        fetch(`/ventas/api/${id}`)
            .then(response => {
                if (!response.ok) throw new Error('Venta no encontrada');
                return response.json();
            })
            .then(venta => {
                document.getElementById('ventaId').value = venta.id;
                document.getElementById('numeroFactura').value = venta.numeroFactura;
                document.getElementById('clienteId').value = venta.clienteId;

                // Limpiar detalles existentes
                document.getElementById('cuerpoDetalles').innerHTML = '';

                // Cargar detalles
                if (venta.detalles && venta.detalles.length > 0) {
                    venta.detalles.forEach(detalle => {
                        agregarDetalle();
                        const ultimaFila = document.querySelector('#cuerpoDetalles tr:last-child');
                        ultimaFila.querySelector('.producto-id').value = detalle.productoid;
                        ultimaFila.querySelector('.cantidad').value = detalle.cantidad;
                        ultimaFila.querySelector('.precio').value = detalle.precioUnitario;
                        calcularSubtotal(contadorDetalles);
                    });
                }

                document.getElementById('modalVentaLabel').innerHTML = '<i class="bi bi-pencil"></i> Editar Venta';
                document.getElementById('numeroFactura').disabled = true;

                new bootstrap.Modal(document.getElementById('modalVenta')).show();
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al cargar la venta', 'danger');
            });
    }

    // Cambiar estado de venta
    function cambiarEstadoVenta(id) {
        document.getElementById('ventaIdEstado').value = id;
        new bootstrap.Modal(document.getElementById('modalEstado')).show();
    }

    // Confirmar cambio de estado
    function confirmarCambioEstado() {
        const id = document.getElementById('ventaIdEstado').value;
        const nuevoEstado = document.getElementById('nuevoEstado').value;

        fetch(`/ventas/api/${id}/estado`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ estado: nuevoEstado })
        })
            .then(response => {
                if (!response.ok) throw new Error('Error al cambiar estado');
                return response.json();
            })
            .then(data => {
                mostrarAlerta('Estado actualizado exitosamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalEstado')).hide();
                cargarVentas();
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al cambiar estado', 'danger');
            });
    }

    // Eliminar venta
    function eliminarVenta(id) {
        if (confirm('¿Está seguro de eliminar esta venta?')) {
            fetch(`/ventas/api/${id}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (response.ok) {
                        mostrarAlerta('Venta eliminada exitosamente', 'success');
                        cargarVentas();
                    } else {
                        throw new Error('Error al eliminar');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarAlerta('Error al eliminar la venta', 'danger');
                });
        }
    }

    // Buscar por número de factura
    function buscarPorFactura() {
        const factura = document.getElementById('searchFactura').value;

        if (!factura.trim()) {
            mostrarAlerta('Ingrese un número de factura para buscar', 'warning');
            return;
        }

        fetch(`/ventas/api/factura/${encodeURIComponent(factura)}`)
            .then(response => {
                if (!response.ok) throw new Error('Venta no encontrada');
                return response.json();
            })
            .then(venta => {
                mostrarVentas([venta]);
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Venta no encontrada', 'warning');
            });
    }

    // Buscar por cliente
    function buscarPorCliente() {
        const clienteId = document.getElementById('searchCliente').value;

        if (!clienteId.trim()) {
            mostrarAlerta('Ingrese un ID de cliente para buscar', 'warning');
            return;
        }

        fetch(`/ventas/api/cliente/${encodeURIComponent(clienteId)}`)
            .then(response => {
                if (!response.ok) throw new Error('Error en búsqueda');
                return response.json();
            })
            .then(ventas => {
                mostrarVentas(ventas);
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al buscar ventas', 'danger');
            });
    }

    // Filtrar por estado
    function filtrarPorEstado() {
        const estado = document.getElementById('filterEstado').value;

        if (!estado) {
            cargarVentas();
            return;
        }

        fetch(`/ventas/api/estado/${encodeURIComponent(estado)}`)
            .then(response => {
                if (!response.ok) throw new Error('Error en filtro');
                return response.json();
            })
            .then(ventas => {
                mostrarVentas(ventas);
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al filtrar ventas', 'danger');
            });
    }

    // Limpiar formulario
    function limpiarFormulario() {
        document.getElementById('formVenta').reset();
        document.getElementById('ventaId').value = '';
        document.getElementById('cuerpoDetalles').innerHTML = '';
        document.getElementById('totalVenta').textContent = '0.00';
        document.getElementById('modalVentaLabel').innerHTML = '<i class="bi bi-cart-plus"></i> Nueva Venta';
        document.getElementById('numeroFactura').disabled = false;
        contadorDetalles = 0;
    }

    // Mostrar alertas
    function mostrarAlerta(mensaje, tipo) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            <i class="bi bi-${tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'} me-2"></i>
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }

    // Permitir buscar con Enter
    document.getElementById('searchFactura')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            buscarPorFactura();
        }
    });

    document.getElementById('searchCliente')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            buscarPorCliente();
        }
    });
</script>
</body>
</html>